!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.FormRules=b()}(this,function(){"use strict";var a=function(a){return a.tagName.toLowerCase()},b=function(b){return-1===["input","select","img"].indexOf(a(b))},c=function(b){return-1<["input","select","textarea"].indexOf(a(b))},d={PLUS:1,MINUS:2,MULTIPLY:3,PERIOD:4,BACKSLASH:5,COLON:6,PERCENT:7,PIPE:8,DOUBLE_PIPE:9,EXCLAMATION:10,QUESTION:11,POUND:12,AMP:13,DOUBLE_AMP:14,SEMI:15,SEMI_VALUE:";",COMMA:16,L_PAREN:17,L_PAREN_VALUE:"(",R_PAREN:18,R_PAREN_VALUE:")",L_ANG:19,R_ANG:20,L_BRACE:21,R_BRACE:22,L_BRACKET:23,R_BRACKET:24,EQUALS:25,DIVIDE:26,COMMENT:27,IDENTIFIER:28,NUMBER:29,QUOTE:30,SPACE:31},e=function(a){this.form=a,this.rules=[],this.named={},this.init()};e.prototype={init:function(){var a,b=this.form.querySelectorAll("[data-rules]");for(a=0;a<b.length;a++)this.rules.push(new f.Context(b[a],this));for(a=0;a<this.rules.length;a++)this.rules[a].setup()},values:function(){var a,b=[];for(a=0;a<this.rules.length;a++)b.push(this.rules[a].content());return b},validate:function(){var a,b=!0;for(a=0;a<this.rules.length;a++)b=this.rules[a].validate()&&b;return b}};var f=e;return f.functions={value:function(a){var b=a.selector();return function(a){switch(b){case"self":return function(){return a.element.value};default:var d=a.container.querySelector(b);if(null===d)throw"Invalid CSS selector of element";if(!c(d))throw"Invalid context element";return function(){return d.value}}}},radio:function(a){var b=a.selector();return function(a){var c=a.container.querySelectorAll(b);return function(){var a,b=!1;for(a=0;a<c.length;a++)b=b||c[a].checked;return b?"on":""}}}},f.config={container:{self:function(){return function(a){if(!b(a.root))throw"Invalid context container";a.container=a.root}},parent:function(){return function(a){a.container=a.root.parentNode}},query:function(a){var c=a.selector();return function(a){var d=a.form.querySelector(c);if(null===d)throw"Invalid CSS selector of container";if(!b(d))throw"Invalid context container";a.container=d}}},id:function(a){var b=a.safe();if(d.IDENTIFIER===b.name||d.QUOTE===b.name)return function(a){a.id=b.value,a.form.named[a.id]=a};if(d.SEMI_VALUE!==a.next())throw'Parse error: ";" expected'},element:{self:function(){return function(a){a.element=function(){if(!c(a.root))throw"Invalid context element";return a.root}}},query:function(a){var b=a.selector();return function(a){a.element=function(){var a=query(b);if(null===a)throw"Invalid CSS selector of element";if(!c(a))throw"Invalid context element";return a}}}},content:function(a){var b=a.stringExpr({value:f.functions.value,radio:f.functions.radio});return function(a){for(var c=0;c<b.length;c++)b[c].call?b[c]=b[c](a):"string"==typeof b[c]&&(b[c]=function(){return this}.bind(b[c]));a.content=function(){var a,c="";for(a=0;a<b.length;a++)c+=b[a]();return c}}},mandatory:{required:function(){return function(a){return function(){return""!==a.content().trim()||"required"}}},optional:!1}},f.Context=function(a,b){this.container=null,this.form=b,this.root=a,this.element=null,this.id=null,this.content=null,this.rules=[],this.definition=a.getAttribute("data-rules"),this.processor=null,this.init={container:f.config.container.parent(),element:f.config.element.self(),content:function(a){a.content=function(){return a.element().value}},rules:[]},this.parse()},f.Context.prototype={parse:function(){this.processor=new f.Processor(this),this.processor.parse()},setup:function(){for(var a in this.init)this.init[a].call&&this.init[a](this);for(var b=0;b<this.init.rules.length;b++)this.rules.push(this.init.rules[b](this))},validate:function(){var a;this.reset();for(var b=0;b<this.rules.length;b++)if(!0!==(a=this.rules[b]()))return this.alert(a),!1;return!0},alert:function(a){var b=this.container.querySelector("label.err-"+a);null!==b&&b.classList.add("err-visible")},reset:function(){for(var a=this.container.querySelectorAll("label.err-visible"),b=0;b<a.length;b++)a[b].classList.remove("err-visible")}},f.Processor=function(a){this.lexer=new f.Lexer,this.context=a},f.Processor.prototype={parse:function(){this.lexer.input(this.context.definition);for(var a;null!==(a=this.lexer.token());)if(d.IDENTIFIER===a.name)if(f.config[a.value]){if(d.COLON!==this.safe().name)throw'Parse error: ":" expected';if(this.context.init[a.value])if(f.config[a.value].call)this.context.init[a.value]=f.config[a.value](this);else{var b=this.configToken(f.config[a.value]);!1!==b&&(this.context.init[a.value]=f.config[a.value][b](this))}else if(f.config[a.value].call)this.context.init.rules.push(f.config[a.value](this));else{var b=this.configToken(f.config[a.value]);!1!==b&&this.context.init.rules.push(f.config[a.value][b](this))}}else this.skipToSemi()},configToken:function(a){var b=this.lexer.token();if(d.IDENTIFIER!==b.name)throw"Parse error: IDENTIFIER expected";if(!a[b.value])throw'Parse error: unexpected value "'+b.value+'"';return!!a[b.value].call&&b.value},skipToSemi:function(){do var a=this.lexer.token();while(null!==a&&d.SEMI!==a.name)},safe:function(){var a=this.lexer.token();if(null===a)throw"Parse error: unexpected end of string";return a},func:function(a,b){if(d.IDENTIFIER===b.name&&a[b.value])return a[b.value](this);throw'Parse error: invalid function name "'+b.value+'"'},funcArgs:function(){var a,b=0,c=[];if(d.L_PAREN!==this.safe().name)throw'Parse error: "(" expected';for(;d.R_PAREN!==(a=this.safe()).name||0!==b;)d.L_PAREN===a.name&&b++,d.R_PAREN===a.name&&b--,c.push(a);return c},selector:function(){this.lexer.skipSpace=!1;var a,b=this.funcArgs(),c="";for(this.lexer.skipSpace=!0,a=0;a<b.length;a++)c+=b[a].value;return c},stringExpr:function(a){for(var b,c=[];!this.lexer.eos()&&d.SEMI!==(b=this.safe()).name;)switch(b.name){case d.IDENTIFIER:d.L_PAREN_VALUE===this.lexer.next()&&c.push(this.func(a,b));break;case d.QUOTE:c.push(b.value)}return c}},f.Lexer=function(a,b){var c=function(){this.pos=0,this.buf=null,this.buflen=0,this.skipSpace=!0};return c.prototype={input:function(a){this.pos=0,this.buf=a,this.buflen=a.length},token:function(c){if(b.skip(this),this.eos())return null;var d=this.buf.charAt(this.pos);if("/"===d){var e=this.next();return"/"===e?b.cm(this):{name:d.DIVIDE,value:"/",pos:this.pos++}}var f=a[d];if(void 0!==f){if(f===d.AMP||f===d.PIPE){var e=this.next();if(e===d){if(f===d.AMP)return{name:d.DOUBLE_AMP,value:d+e,pos:this.pos++};if(f===d.PIPE)return{name:d.DOUBLE_PIPE,value:d+e,pos:this.pos++}}}return{name:f,value:d,pos:this.pos++}}return b.isA(d)?b.id(this):b.isDg(d)?b.num(this):b.quot(this,d)},next:function(){return this.buf.charAt(this.pos)},eos:function(){return this.pos>=this.buflen}},c}({"+":d.PLUS,"-":d.MINUS,"*":d.MULTIPLY,".":d.PERIOD,"\\":d.BACKSLASH,":":d.COLON,"%":d.PERCENT,"|":d.PIPE,"!":d.EXCLAMATION,"?":d.QUESTION,"#":d.POUND,"&":d.AMPERSAND,";":d.SEMI,",":d.COMMA,"(":d.L_PAREN,")":d.R_PAREN,"<":d.L_ANG,">":d.R_ANG,"{":d.L_BRACE,"}":d.R_BRACE,"[":d.L_BRACKET,"]":d.R_BRACKET,"=":d.EQUALS," ":d.SPACE},{isNl:function(a){return"\r"===a||"\n"===a},isDg:function(a){return a>="0"&&a<="9"},isA:function(a){return a>="a"&&a<="z"||a>="A"&&a<="Z"||"_"===a||"$"===a},isAN:function(a){return a>="a"&&a<="z"||a>="A"&&a<="Z"||a>="0"&&a<="9"||"_"===a||"$"===a},skip:function(a){for(;a.pos<a.buflen;){var b=a.buf.charAt(a.pos);if(!(a.skipSpace&&" "==b||"\t"==b||"\r"==b||"\n"==b))break;a.pos++}},cm:function(a){for(var b=a.pos+2,c=a.buf.charAt(a.pos+2);b<a.buflen&&!this.isNl(a.buf.charAt(b));)b++;var d={name:c.COMMENT,value:a.buf.substring(a.pos,b),pos:a.pos};return a.pos=b+1,d},id:function(a){for(var b=a.pos+1;b<a.buflen&&this.isAN(a.buf.charAt(b));)b++;var c={name:d.IDENTIFIER,value:a.buf.substring(a.pos,b),pos:a.pos};return a.pos=b,c},num:function(a){for(var b=a.pos+1;b<a.buflen&&this.isDg(a.buf.charAt(b));)b++;var c={name:d.NUMBER,value:a.buf.substring(a.pos,b),pos:a.pos};return a.pos=b,c},quot:function(a,b){var c=a.buf.indexOf(b,a.pos+1);if(c===-1)throw Error("Unterminated quote at "+a.pos);var e={name:d.QUOTE,value:a.buf.substring(a.pos+1,c),pos:a.pos};return a.pos=c+1,e}}),f});